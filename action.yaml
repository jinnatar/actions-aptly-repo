---
name: "Aptly deb repo creator"
author: "Jinna Kiisuo <jinnak@nocturnal.fi>"
description: |
  Create ad-hoc deb repositories into GitHub artifacts.
  These can be published onwards into GitHub Pages.

inputs:
  repos:
    description: |
      "Repositories to create. Provided as a semicolon separated csv."
    required: true
    default: "debian;stable;amd64;./*.deb"
  gpg_key_id:
    description: |
      ID of the GPG public key to use for signing.
      Useful for definining a signing specific subkey.
    required: true
    default: ""
  gpg_private_key:
    description: Armored gpg private key to sign the repo with.
    required: true
  gpg_passphrase:
    description: The passphrase of the provided GPG key.
    required: true

  GITHUB_TOKEN:
    description: |
      A GitHub token, available in the secrets.GITHUB_TOKEN working-directory variable.
    default: ${{ github.token }}

runs:
  using: composite
  steps:
    - name: Add this action's path to PATH
      shell: bash
      run: echo "${{ github.action_path }}" >> $GITHUB_PATH
    - name: Install Aptly
      uses: eth-pkg/apt-deb-cache@v0.2.6
      with:
        packages: "aptly"
    - name: Install UBI
      shell: bash
      run: |
        curl --silent --location \
            https://raw.githubusercontent.com/houseabsolute/ubi/master/bootstrap/bootstrap-ubi.sh |
            sh
    - name: Install XSV
      shell: bash
      run: ubi -p BurntSushi/xsv -i ./
    - name: Create repository
      shell: bash
      run: |
        echo "${{ inputs.repos }}" | create-aptly-repos.sh
    - name: Add debs
      shell: bash
      run: "aptly repo add ${{ inputs.repository }} ${{ inputs.glob }}"
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: "${{ inputs.gpg_private_key }}"
        passphrase: "${{ inputs.gpg_passphrase }}"
    - name: Sign & publish repo
      shell: bash
      run: |
        aptly publish repo \
          -distribution "${{ inputs.distribution }}" \
          -component "${{ inputs.component }}" \
          "${{ inputs.repository }}"
